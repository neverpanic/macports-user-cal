# $Id$

PortSystem          1.0

name                mpstats
version             0.1
categories          sysutils
license             BSD
platforms           darwin
supported_archs     noarch
maintainers         cal openmaintainer
description         submit statistics about your macports installation
long_description \
   This is a script and LaunchAgent which will run weekly to report \
   information about your system and installed ports to a server, which \
   publishes the aggregate statistics on the web. \
   \nThis helps us to make better decisions on which configurations we should \
   support and test more and which ports are most commonly used.

homepage            http://www.macports.org/
distfiles

set launchd_dir     ${prefix}/etc/${startupitem.location}/${startupitem.uniquename}/

startupitem.create   no
startupitem.autostart \
                    yes

extract.mkdir       yes
extract {
    xinstall -m 644 -W ${filespath} mpstats.tcl mpstats.plist.default ${worksrcpath}
}

configure {
    reinplace "s|@PREFIX@|${prefix}|g" \
        ${worksrcpath}/mpstats.tcl \
        ${worksrcpath}/mpstats.plist.default
    reinplace "s|@LABEL@|${startupitem.uniquename}|g" \
        ${worksrcpath}/mpstats.plist.default
}

build {}

destroot {
    xinstall -m 755 \
        ${worksrcpath}/mpstats.tcl \
        ${destroot}${prefix}/libexec/mpstats

    xinstall -m 755 -d \
        ${destroot}${launchd_dir}
    xinstall -m 444 \
        ${worksrcpath}/mpstats.plist.default \
        ${destroot}${launchd_dir}${startupitem.plist}.default

    xinstall -m 444 \
        ${filespath}/mpstats.conf \
        ${destroot}${prefix}/etc/mpstats.conf.default

    # install the plist, if startupitem.install is set
    if {[getuid] == 0 && ${startupitem.install} ne no} {
        xinstall -m 755 -d ${destroot}/Library/${startupitem.location}
        # note this symlink *will* be broken at destroot time; we'll place the
        # correct file there on activation
        ln -sf "${launchd_dir}${startupitem.plist}" "${destroot}/Library/${startupitem.location}"
    }
}

post-activate {
    if {![file exists ${prefix}/etc/mpstats.conf]} {
        xinstall -m 644 \
            ${prefix}/etc/mpstats.conf.default \
            ${prefix}/etc/mpstats.conf

        reinplace "s|@STATS_UUID@|[exec uuidgen]|" \
            ${prefix}/etc/mpstats.conf
    }

    # the result of this will usually be too large for a 64bit integer, but we don't really care
    set hwuuid [exec system_profiler SPHardwareDataType | grep "Hardware UUID" | awk "/Hardware UUID/ {print \$3}" | tr -d - | bc]
    xinstall -m 644 \
        ${launchd_dir}${startupitem.plist}.default \
        ${launchd_dir}${startupitem.plist}
    reinplace "s|@WEEKDAY@|[expr $hwuuid % 7]|g" \
        ${launchd_dir}${startupitem.plist}
    reinplace "s|@HOUR@|[clock format [clock seconds] -format %H]|g" \
        ${launchd_dir}${startupitem.plist}
    reinplace "s|@MINUTE@|[clock format [clock seconds] -format %M]|g" \
        ${launchd_dir}${startupitem.plist}
}

post-deactivate {
    delete -force ${launchd_dir}${startupitem.plist}
}

notes \
    "Installing this port automatically enables weekly reporting of data to the stats server. \
     Uninstall or deactivate this port if you want to stop providing data to MacPorts."
