# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id $

PortSystem              1.0

name                    gtk-vnc
version                 0.5.1
categories              gnome
platforms               darwin
maintainers             cal openmaintainer

description             gtk-vnc is a VNC viewer widget for GTK.
long_description        ${description} It is built using coroutines allowing it to be completely \
                        asynchronous while remaining single threaded. It provides a core C \
                        library, and bindings for Python (PyGTK).
homepage                http://live.gnome.org/gtk-vnc/
license                 LGPL-2+
master_sites            gnome
master_sites.mirror_subdir \
                        sources/${name}/[join [lrange [split ${version} .] 0 1] .]
use_xz                  yes
checksums               rmd160  9b21f59911c4aeea70bd3171066956c65ad59b8e \
                        sha256  1ad1847a23f8ea8fbf2396de46c51ec0900ee3698cde4e205760518cd1e01a40

patchfiles              patch-continuation-h.diff \
                        patch-coroutine_ucontext-c.diff \
                        patch-vncmodule-c.diff

depends_build           port:intltool \
                        port:pkgconfig
depends_lib             port:gnutls

proc _setup_python_specifics {pyversion versionstring} {
    global frameworks_dir

    depends_lib-append  port:py${pyversion}-pygtk
    eval "post-configure { \
        reinplace -E \"s#pygtk-codegen-2.0#pygtk-codegen-2.0-${versionstring}#g\" \"\${worksrcpath}/src/Makefile\" \
        }"
    configure.env-append    PKG_CONFIG_PATH="${frameworks_dir}/Python.framework/Versions/${versionstring}/lib/pkgconfig"
    build.env-append        PKG_CONFIG_PATH="${frameworks_dir}/Python.framework/Versions/${versionstring}/lib/pkgconfig"
    eval "post-destroot { \
            file mkdir \"\${destroot}\${frameworks_dir}/Python.framework/Versions/${versionstring}/lib\" \n
            file rename \"\${destroot}\${prefix}/lib/python${versionstring}/site-packages\" \"\${destroot}\${frameworks_dir}/Python.framework/Versions/${versionstring}/lib/python${versionstring}\" \
        }"
}

variant python27 description {Build against Python 2.7} conflicts python32 python33 {
    _setup_python_specifics 27 "2.7"
}
variant python32 description {Build against Python 3.2} conflicts python27 python33 {
    _setup_python_specifics 32 "3.2"
}
variant python33 description {Build against Python 3.3} conflicts python27 python32 {
    _setup_python_specifics 33 "3.3"
}
if {![variant_isset python32] && ![variant_isset python33]} {
    default_variants +python27
}
if {![variant_isset python32] && ![variant_isset python33] && ![variant_isset python27]} {
    pre-fetch {
        error "You must choose one of the python variants"
    }
}

# required to use some deprecated symbols the compiler would #error out of
configure.cflags-append -D_XOPEN_SOURCE
configure.args          --enable-plugin=no \
                        --disable-introspection \
                        --disable-vala \
                        --with-gtk=2.0 \
                        --with-python \
                        --without-examples \
                        --with-libview \
                        --without-pulseaudio \
                        --without-sasl \
                        --with-coroutine=gthread
configure.env-append    CPPFLAGS=-Werror=unknown-warning-option
build.args-append       NO_UNDEFINED_FLAGS=""
